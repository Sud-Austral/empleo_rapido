<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Empleo Público - Estadísticas</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 2px 8px -2px rgba(15, 23, 42, 0.06)'
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Vibrant Professional Palette */
            --bg-body: #e2e8f0;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            /* Slate 900 */
            --text-secondary: #475569;
            /* Slate 600 */
            --text-muted: #94a3b8;
            --border-color: #cbd5e1;

            --accent-primary: #4f46e5;
            /* Indigo 600 */
            --accent-blue: #0ea5e9;
            /* Sky 500 */
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
        }

        /* --- Global Layout --- */
        .inst-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2.5rem;
            margin-bottom: 2.5rem;
            position: relative;
        }

        .inst-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #4f46e5, #0ea5e9, #6366f1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.35rem;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
        }

        /* --- Filters --- */
        .filter-panel {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .inst-select {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.65rem 0.9rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            outline: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .inst-select:hover {
            border-color: #94a3b8;
        }

        /* --- KPI Cards --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
        }

        .kpi-card.accent-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-blue);
            border-radius: 12px 12px 0 0;
            opacity: 0.9;
        }

        .kpi-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .kpi-val {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0.5rem 0;
            line-height: 1.1;
        }

        .kpi-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-weight: 500;
        }

        /* --- Content Sections --- */
        .content-section {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            margin-bottom: 2.5rem;
            overflow: hidden;
            box-shadow: 0 4px 20px -4px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04);
        }

        .sec-header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid #f1f5f9;
            background: white;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sec-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: #eff6ff;
            color: #3b82f6;
        }

        .sec-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
            letter-spacing: -0.01em;
        }

        .sec-body {
            padding: 2rem;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 3rem;
        }

        .chart-box h4 {
            font-size: 0.9rem;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 1.25rem;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
            width: 100%;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 1.2rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: #f8fafc;
            color: #0f172a;
            border-color: #cbd5e1;
        }

        /* === NUEVAS MEJORAS UI/UX === */

        /* Barra de progreso de scroll */
        #scrollProgress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #4f46e5, #0ea5e9, #10b981);
            z-index: 9999;
            transition: width 0.1s ease-out;
        }

        /* Animaciones de entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .content-section {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        .content-section:nth-child(1) {
            animation-delay: 0.1s;
        }

        .content-section:nth-child(2) {
            animation-delay: 0.15s;
        }

        .content-section:nth-child(3) {
            animation-delay: 0.2s;
        }

        .content-section:nth-child(4) {
            animation-delay: 0.25s;
        }

        .content-section:nth-child(5) {
            animation-delay: 0.3s;
        }

        .kpi-card {
            animation: fadeInUp 0.4s ease-out forwards;
            opacity: 0;
        }

        .kpi-card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .kpi-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .kpi-card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .kpi-card:nth-child(4) {
            animation-delay: 0.2s;
        }

        /* Glassmorphism en header */
        .inst-header {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Gradiente animado en header */
        .inst-header::before {
            background: linear-gradient(90deg, #4f46e5, #0ea5e9, #10b981, #4f46e5);
            background-size: 300% 100%;
            animation: gradientMove 4s ease infinite;
        }

        /* Filter Chips (Filtros activos) */
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 9999px;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
            animation: fadeIn 0.3s ease;
        }

        .filter-chip .chip-label {
            opacity: 0.8;
            font-weight: 500;
        }

        .filter-chip .chip-value {
            font-weight: 700;
        }

        .filter-chip .chip-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip .chip-remove:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .filter-chip .chip-remove svg {
            width: 10px;
            height: 10px;
        }

        /* Skeleton loader */
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 1.5rem;
            width: 60%;
            margin-bottom: 0.5rem;
        }

        .skeleton-chart {
            height: 280px;
            width: 100%;
            border-radius: 8px;
        }

        /* Micro-animación KPIs */
        .kpi-val {
            transition: all 0.3s ease;
        }

        .kpi-val.counting {
            animation: countUp 0.6s ease-out;
        }

        /* Sombras con color por sección */
        .content-section:nth-child(odd) {
            box-shadow: 0 4px 24px -4px rgba(79, 70, 229, 0.12), 0 2px 8px -2px rgba(0, 0, 0, 0.04);
        }

        .content-section:nth-child(even) {
            box-shadow: 0 4px 24px -4px rgba(14, 165, 233, 0.12), 0 2px 8px -2px rgba(0, 0, 0, 0.04);
        }

        /* Tooltips enriquecidos */
        .chart-tooltip-rich {
            background: rgba(15, 23, 42, 0.95) !important;
            backdrop-filter: blur(8px);
            border-radius: 8px !important;
            padding: 12px 16px !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hover interactivo en gráficos */
        .chart-wrapper canvas {
            transition: transform 0.2s ease;
        }

        .chart-wrapper:hover canvas {
            transform: scale(1.01);
        }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .charts-row {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .inst-header {
                padding: 1.5rem;
            }
        }
    </style>
</head>


<body>
    <main class="max-w-[1700px] mx-auto pb-12">

        <!-- HEADER -->
        <header class="inst-header">
            <div class="header-top">
                <div class="header-brand">
                    <div class="brand-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6"
                            fill="currentColor">
                            <path d="M3 3h18v18H3V3z" />
                        </svg></div>
                    <div>
                        <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">Monitor Estadístico</h1>
                        <p class="text-sm text-slate-500 font-medium">Panel Integral de Empleo Público - 20 Áreas de
                            Análisis</p>
                    </div>
                </div>
                <!-- Breadcrumbs -->
                <nav aria-label="breadcrumb" class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
                    <ol class="flex items-center space-x-2">
                        <li><a href="#" class="hover:underline">Inicio</a></li>
                        <li>/</li>
                        <li class="font-medium text-gray-800">Dashboard</li>
                    </ol>
                </nav>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block px-4 border-r border-slate-200">
                        <div class="text-[0.65rem] text-slate-400 font-bold uppercase tracking-wider">Actualización
                        </div>
                        <div class="text-sm font-semibold text-slate-700" id="lastUpdate">--/--/----</div>
                    </div>
                    <a href="index.html" class="btn-back">
                        <i class="fas fa-arrow-left"></i> Volver a Tabla
                    </a>
                </div>
            </div>

            <div class="filter-panel">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1" for="filterYear">Año de
                        Entrada</label>
                    <select id="filterYear" class="inst-select">
                        <option value="all">Todo el periodo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1"
                        for="filterOrgPadre">Institución
                        Superior</label>
                    <select id="filterOrgPadre" class="inst-select">
                        <option value="all">Todas las Instituciones</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1"
                        for="filterOrganismo">Organismo</label>
                    <select id="filterOrganismo" class="inst-select">
                        <option value="all">Todos los Organismos</option>
                    </select>
                </div>
                <!-- Botón Limpiar Filtros -->
                <div class="flex items-end">
                    <button id="btnClearFilters"
                        class="px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold text-sm rounded-lg border border-slate-300 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Limpiar Filtros
                    </button>
                </div>
            </div>

            <!-- Filtros Activos -->
            <div id="activeFiltersContainer" class="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100 hidden">
                <div class="flex items-center gap-3 flex-wrap">
                    <span class="text-xs font-bold text-indigo-600 uppercase flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        Filtros activos:
                    </span>
                    <div id="activeFiltersTags" class="flex flex-wrap gap-2">
                        <!-- Los tags se generan dinámicamente -->
                    </div>
                </div>
            </div>

            <div
                class="flex flex-wrap gap-x-8 gap-y-2 mt-6 pt-4 border-t border-slate-100 text-sm font-medium text-slate-600">
                <div class="flex items-center gap-2">
                    <i class="fas fa-layer-group text-slate-400"></i>
                    <span>Total Registros: <strong id="headerTotalRecords" class="text-slate-900">...</strong></span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-coins text-slate-400"></i>
                    <span>Masa Salarial Global: <strong id="headerTotalMoney" class="text-slate-900">...</strong></span>
                </div>
            </div>
        </header>

        <div class="px-4 md:px-10">

            <!-- KPIs ROW 1 -->
            <div class="kpi-grid">
                <div class="kpi-card accent-top bg-sky-50/50" style="--accent-blue: #0ea5e9;">
                    <div class="kpi-title">Dotación Total</div>
                    <div class="kpi-val" id="statTotalFuncionarios">...</div>
                    <div class="kpi-sub"><i class="fas fa-users text-sky-500"></i> Funcionarios activos</div>
                </div>
                <div class="kpi-card accent-top bg-indigo-50/50" style="--accent-blue: #6366f1;">
                    <div class="kpi-title">Gasto Mensual</div>
                    <div class="kpi-val" id="statGastoTotal">...</div>
                    <div class="kpi-sub"><i class="fas fa-money-bill-wave text-indigo-500"></i> Suma bruta</div>
                </div>
                <div class="kpi-card accent-top bg-violet-50/50" style="--accent-blue: #8b5cf6;">
                    <div class="kpi-title">Remuneración Avg</div>
                    <div class="kpi-val" id="statRemPromedio">...</div>
                    <div class="kpi-sub"><i class="fas fa-wallet text-violet-500"></i> Promedio simple</div>
                </div>
                <div class="kpi-card accent-top bg-amber-50/50" style="--accent-blue: #f59e0b;">
                    <div class="kpi-title">Edad Promedio</div>
                    <div class="kpi-val" id="statEdadPromedio">...</div>
                    <div class="kpi-sub"><i class="fas fa-cake-candles text-amber-500"></i> Años</div>
                </div>
            </div>

            <!-- KPIs ROW 2 -->
            <div class="kpi-grid">
                <div class="kpi-card bg-pink-50/50">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="kpi-title">Mujeres</div>
                            <div class="kpi-val text-2xl" id="statMujeres">...</div>
                        </div>
                        <div class="text-pink-600 bg-white/60 rounded-lg p-3 border border-pink-100"><i
                                class="fas fa-venus text-xl"></i></div>
                    </div>
                </div>
                <div class="kpi-card bg-blue-50/50">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="kpi-title">Hombres</div>
                            <div class="kpi-val text-2xl" id="statHombres">...</div>
                        </div>
                        <div class="text-blue-600 bg-white/60 rounded-lg p-3 border border-blue-100"><i
                                class="fas fa-mars text-xl"></i></div>
                    </div>
                </div>
                <div class="kpi-card bg-slate-50/50">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="kpi-title">Organismos</div>
                            <div class="kpi-val text-2xl" id="statOrganismos">...</div>
                        </div>
                        <div class="text-slate-600 bg-white/60 rounded-lg p-3 border border-slate-200"><i
                                class="fas fa-building text-xl"></i></div>
                    </div>
                </div>
                <div class="kpi-card bg-emerald-50/50">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="kpi-title">Top Remuneración</div>
                            <div class="kpi-val text-2xl" id="statMaxRemuneracion">...</div>
                        </div>
                        <div class="text-emerald-600 bg-white/60 rounded-lg p-3 border border-emerald-100"><i
                                class="fas fa-trophy text-xl"></i></div>
                    </div>
                </div>
            </div>

            <!-- SECTIONS 1-10 (Original Revised) -->
            <!-- 1. Distribución Contractual -->
            <div class="content-section" id="section-1">
                <div class="sec-header">
                    <div class="sec-icon-box"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                            class="w-6 h-6" fill="currentColor">
                            <path d="M4 4h16v16H4V4z" />
                        </svg></div>
                    <span class="sec-title">1. Distribución Contractual</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Tipo de Contrato</h4>
                            <div class="chart-wrapper"><canvas id="chart1_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Composición por Género</h4>
                            <div class="chart-wrapper"><canvas id="chart1_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Panorama Institucional -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#ecfeff; color:#06b6d4"><i
                            class="fas fa-building-columns"></i></div>
                    <span class="sec-title">2. Panorama Institucional</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Top Dotación</h4>
                            <div class="chart-wrapper"><canvas id="chart2_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Top Gasto Salarial</h4>
                            <div class="chart-wrapper"><canvas id="chart2_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Análisis Remuneracional -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#f5f3ff; color:#7c3aed"><i
                            class="fas fa-sack-dollar"></i>
                    </div>
                    <span class="sec-title">3. Análisis Remuneracional</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Promedio por Contrato (CLP)</h4>
                            <div class="chart-wrapper"><canvas id="chart3_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Registros por Año (Evolución)</h4>
                            <div class="chart-wrapper"><canvas id="chart3_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Demografía -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fff7ed; color:#ea580c"><i class="fas fa-users"></i>
                    </div>
                    <span class="sec-title">4. Demografía</span>
                </div>
                <div class="sec-body">
                    <div class="w-full">
                        <div class="chart-box">
                            <h4>Distribución Etaria</h4>
                            <div class="chart-wrapper"><canvas id="chart4_1"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Formación -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#f0f9ff; color:#0ea5e9"><i
                            class="fas fa-graduation-cap"></i></div>
                    <span class="sec-title">5. Formación Académica</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Nivel Educacional</h4>
                            <div class="chart-wrapper"><canvas id="chart5_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Top Títulos</h4>
                            <div class="chart-wrapper"><canvas id="chart5_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Equidad -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fdf2f8; color:#db2777"><i
                            class="fas fa-scale-balanced"></i></div>
                    <span class="sec-title">6. Equidad de Género</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Brecha Salarial Promedio</h4>
                            <div class="chart-wrapper"><canvas id="chart6_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Participación %</h4>
                            <div class="chart-wrapper"><canvas id="chart6_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. Ingresos -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#ecfdf5; color:#059669"><i class="fas fa-wallet"></i>
                    </div>
                    <span class="sec-title">7. Distribución de Ingresos</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Rangos de Sueldo</h4>
                            <div class="chart-wrapper"><canvas id="chart7_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Evolución Promedio Anual</h4>
                            <div class="chart-wrapper"><canvas id="chart7_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- 9. Rankings -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#eef2ff; color:#4f46e5"><i
                            class="fas fa-ranking-star"></i>
                    </div>
                    <span class="sec-title">8. Rankings Avanzados</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Mayor Sueldo Promedio</h4>
                            <div class="chart-wrapper"><canvas id="chart9_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Mayor Dotación Profesional</h4>
                            <div class="chart-wrapper"><canvas id="chart9_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- NUEVAS SECCIONES 11-20 -->

            <!-- 9. Talento Joven -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#ecfdf5; color:#10b981"><i class="fas fa-seedling"></i>
                    </div>
                    <span class="sec-title">9. Talento Joven (< 30 Años)</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Dónde trabajan los Jóvenes (Top 5 Orgs)</h4>
                            <div class="chart-wrapper"><canvas id="chart11_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Sueldo Promedio: Joven vs General</h4>
                            <div class="chart-wrapper"><canvas id="chart11_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 12. Retiro -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fff7ed; color:#f97316"><i
                            class="fas fa-user-clock"></i>
                    </div>
                    <span class="sec-title">10. Proyección de Retiro (> 60 Años)</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Organismos con mayor dotación Senior</h4>
                            <div class="chart-wrapper"><canvas id="chart12_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Costo Mensual Planilla Senior</h4>
                            <div class="chart-wrapper"><canvas id="chart12_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 11. Alta Dirección -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fefce8; color:#ca8a04"><i class="fas fa-crown"></i>
                    </div>
                    <span class="sec-title">11. Alta Dirección (Top 10% Ingresos)</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Concentración de Altos Sueldos por Org.</h4>
                            <div class="chart-wrapper"><canvas id="chart13_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Brecha con Promedio General (Multiplicador)</h4>
                            <div class="chart-wrapper"><canvas id="chart13_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 12. Base Operativa -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#f0f9ff; color:#0284c7"><i
                            class="fas fa-layer-group"></i>
                    </div>
                    <span class="sec-title">12. Base Operativa (Sueldos Bajos)</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Orgs con más sueldos < 700k</h4>
                                    <div class="chart-wrapper"><canvas id="chart14_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Género en Base Operativa</h4>
                            <div class="chart-wrapper"><canvas id="chart14_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 15. Dispersión -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#f5f3ff; color:#7c3aed"><i
                            class="fas fa-chart-area"></i>
                    </div>
                    <span class="sec-title">13. Dispersión Salarial Interna</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Brecha Max-Min por Organismo</h4>
                            <div class="chart-wrapper"><canvas id="chart15_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Ratio Dispersión (Max/Min)</h4>
                            <div class="chart-wrapper"><canvas id="chart15_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 16. Tamaño -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#ecfeff; color:#0891b2"><i class="fas fa-sitemap"></i>
                    </div>
                    <span class="sec-title">14. Estructura Organizacional</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Distribución de Dotación (Pareto)</h4>
                            <div class="chart-wrapper"><canvas id="chart16_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Sueldo Promedio vs Tamaño Organismo</h4>
                            <div class="chart-wrapper"><canvas id="chart16_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 17. Profesionalización -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fff1f2; color:#be123c"><i
                            class="fas fa-user-graduate"></i>
                    </div>
                    <span class="sec-title">15. Grado de Profesionalización</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Ratio Profesionales vs Otros</h4>
                            <div class="chart-wrapper"><canvas id="chart17_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Brecha Salarial por Título</h4>
                            <div class="chart-wrapper"><canvas id="chart17_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 18. Eficiencia -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#f8fafc; color:#475569"><i
                            class="fas fa-file-invoice-dollar"></i></div>
                    <span class="sec-title">16. Costo Laboral Per Cápita</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Ranking Costo Promedio por Funcionario</h4>
                            <div class="chart-wrapper"><canvas id="chart18_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Eficiencia: Dotación vs Gasto Total</h4>
                            <div class="chart-wrapper"><canvas id="chart18_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 17. Crecimiento -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#eff6ff; color:#2563eb"><i
                            class="fas fa-arrow-trend-up"></i></div>
                    <span class="sec-title">17. Dinámica de Crecimiento</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Nuevos Ingresos (Histórico)</h4>
                            <div class="chart-wrapper"><canvas id="chart19_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Variación de Masa Salarial Estimada</h4>
                            <div class="chart-wrapper"><canvas id="chart19_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 18. Antigüedad Laboral -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fef3c7; color:#d97706"><i
                            class="fas fa-hourglass-half"></i></div>
                    <span class="sec-title">18. Antigüedad Laboral</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Distribución por Años de Servicio</h4>
                            <div class="chart-wrapper"><canvas id="chart20_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Promedio de Antigüedad por Organismo</h4>
                            <div class="chart-wrapper"><canvas id="chart20_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 19. Análisis por Tipo de Cargo -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#dbeafe; color:#1d4ed8"><i class="fas fa-briefcase"></i>
                    </div>
                    <span class="sec-title">19. Análisis por Tipo de Cargo</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Distribución por Tipo de Cargo</h4>
                            <div class="chart-wrapper"><canvas id="chart21_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Remuneración Promedio por Tipo de Cargo</h4>
                            <div class="chart-wrapper"><canvas id="chart21_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 20. Análisis de Liquidez -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#fce7f3; color:#be185d"><i
                            class="fas fa-money-check-alt"></i>
                    </div>
                    <span class="sec-title">20. Análisis de Liquidez</span>
                </div>
                <div class="sec-body">
                    <div class="charts-row">
                        <div class="chart-box">
                            <h4>Comparativa Bruto vs Líquido por Organismo</h4>
                            <div class="chart-wrapper"><canvas id="chart22_1"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <h4>Ratio Líquido/Bruto (Top 10 Organismos)</h4>
                            <div class="chart-wrapper"><canvas id="chart22_2"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 21. Nube de Palabras de Cargos -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#f3e8ff; color:#9333ea"><i
                            class="fas fa-comment-dots"></i>
                    </div>
                    <span class="sec-title">21. Nube de Cargos (Más Frecuentes)</span>
                </div>
                <div class="sec-body">
                    <div id="wordCloudContainer"
                        class="flex flex-wrap gap-3 justify-center p-4 bg-slate-50 rounded-xl min-h-[300px] items-center">
                        <!-- Nube generada dinámicamente -->
                        <div class="text-slate-400 italic">Cargando nube de palabras...</div>
                    </div>
                </div>
            </div>

            <!-- 22. Top Ranking de Aumentos -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#dcfce7; color:#16a34a"><i
                            class="fas fa-arrow-trend-up"></i>
                    </div>
                    <span class="sec-title">22. Top Ranking de Aumentos (Entrada vs Salida)</span>
                </div>
                <div class="sec-body">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-4 py-3">Funcionario</th>
                                    <th class="px-4 py-3">Organismo</th>
                                    <th class="px-4 py-3 text-right">Rem. Entrada</th>
                                    <th class="px-4 py-3 text-right">Rem. Salida/Actual</th>
                                    <th class="px-4 py-3 text-right">Diferencia</th>
                                    <th class="px-4 py-3 text-right">% Aumento</th>
                                </tr>
                            </thead>
                            <tbody id="rankingAumentosBody">
                                <!-- Filas generadas dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 23. Tree Map de Gasto -->
            <div class="content-section">
                <div class="sec-header">
                    <div class="sec-icon-box" style="background:#ffedd5; color:#c2410c"><i class="fas fa-chart-pie"></i>
                    </div>
                    <span class="sec-title">23. Distribución de Gasto (Tree Map)</span>
                </div>
                <div class="sec-body">
                    <div id="treeMapContainer"
                        class="w-full h-[400px] bg-slate-100 rounded-xl relative overflow-hidden flex flex-wrap content-start">
                        <!-- Bloques generados dinámicamente -->
                    </div>
                </div>
            </div>


        </div>
    </main>


    <!-- Barra de progreso de scroll -->
    <div id="scrollProgress"></div>

    <!-- Botón Volver Arriba -->
    <button id="btnScrollTop"
        class="fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white w-12 h-12 flex items-center justify-center rounded-full shadow-lg transition-all duration-300 transform translate-y-20 opacity-0 z-50 focus:outline-none hover:scale-110 active:scale-95 group border-2 border-white/20 backdrop-blur-sm"
        aria-label="Volver arriba">
        <i class="fas fa-arrow-up text-lg group-hover:-translate-y-1 transition-transform"></i>
    </button>

    <!-- Logic Script -->
    <script src="estadistica.js?v=7"></script>

    <!-- UI Enhancements Script -->
    <script>
        // Barra de progreso de scroll
        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = (scrollTop / docHeight) * 100;
            document.getElementById('scrollProgress').style.width = progress + '%';
        });

        // Animación de conteo para KPIs
        function animateValue(element, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;
            const timer = setInterval(() => {
                current += increment * Math.ceil(range / 50);
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = current.toLocaleString('es-CL');
            }, stepTime);
        }

        // Observador para animar KPIs cuando entran en vista
        const kpiObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('counting');
                }
            });
        }, { threshold: 0.5 });

        document.querySelectorAll('.kpi-val').forEach(el => kpiObserver.observe(el));

        // === FILTROS ACTIVOS ===
        const filterLabels = {
            filterYear: 'Año',
            filterOrgPadre: 'Institución',
            filterOrganismo: 'Organismo'
        };

        function updateActiveFilters() {
            const container = document.getElementById('activeFiltersContainer');
            const tagsContainer = document.getElementById('activeFiltersTags');
            if (!container || !tagsContainer) return;

            const filters = [
                { id: 'filterYear', el: document.getElementById('filterYear') },
                { id: 'filterOrgPadre', el: document.getElementById('filterOrgPadre') },
                { id: 'filterOrganismo', el: document.getElementById('filterOrganismo') }
            ];

            let html = '';
            let hasActiveFilters = false;

            filters.forEach(f => {
                if (f.el && f.el.value !== 'all') {
                    hasActiveFilters = true;
                    const label = filterLabels[f.id] || f.id;
                    const value = f.el.options[f.el.selectedIndex].text;
                    html += `
                        <div class="filter-chip" data-filter="${f.id}">
                            <span class="chip-label">${label}:</span>
                            <span class="chip-value">${value}</span>
                            <span class="chip-remove" onclick="removeFilter('${f.id}')">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
                            </span>
                        </div>
                    `;
                }
            });

            tagsContainer.innerHTML = html;
            container.classList.toggle('hidden', !hasActiveFilters);
        }

        function removeFilter(filterId) {
            const el = document.getElementById(filterId);
            if (el) {
                el.value = 'all';
                el.dispatchEvent(new Event('change'));
            }
        }

        // Botón limpiar filtros
        document.getElementById('btnClearFilters')?.addEventListener('click', () => {
            ['filterYear', 'filterOrgPadre', 'filterOrganismo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = 'all';
            });
            document.getElementById('filterYear')?.dispatchEvent(new Event('change'));
        });

        // Escuchar cambios en filtros
        ['filterYear', 'filterOrgPadre', 'filterOrganismo'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', updateActiveFilters);
        });

        // Actualizar al cargar
        setTimeout(updateActiveFilters, 1000);

        // === FILTROS EN CASCADA ===
        // Cuando cambia el año, actualizar las opciones de institución
        document.getElementById('filterYear')?.addEventListener('change', function () {
            updateCascadeFilters();
        });

        // Cuando cambia la institución, actualizar las opciones de organismo
        document.getElementById('filterOrgPadre')?.addEventListener('change', function () {
            updateOrganismoOptions();
        });

        function updateCascadeFilters() {
            // Esta función se llamará después de que los datos estén cargados
            // La lógica principal está en estadistica.js
        }

        // === RENDERIZAR GRÁFICOS SECCIONES 19 Y 20 ===
        // Se ejecuta después de que el script principal cargue los datos
        setTimeout(() => {
            // Esperar a que allData esté disponible desde estadistica.js
            if (typeof allData === 'undefined' || !allData.length) {
                console.log('Esperando datos para secciones 19 y 20...');
                return;
            }

            const data = typeof filteredData !== 'undefined' && filteredData.length ? filteredData : allData;

            // === SECCIÓN 19: Análisis por Tipo de Cargo ===
            // Índice de tipo_cargo en el array (según C.TIPO_CONTRATO = 6)
            const TIPO_CARGO_IDX = 6;
            const REM_BRUTA_IDX = 21;

            // Contar por tipo de cargo
            const tipoCargoCounts = {};
            const tipoCargoSums = {};

            data.forEach(r => {
                const tipo = r[TIPO_CARGO_IDX] || 'Sin Clasificar';
                const rem = parseFloat(r[REM_BRUTA_IDX]) || 0;

                if (!tipoCargoCounts[tipo]) {
                    tipoCargoCounts[tipo] = 0;
                    tipoCargoSums[tipo] = 0;
                }
                tipoCargoCounts[tipo]++;
                tipoCargoSums[tipo] += rem;
            });

            // Ordenar por cantidad y tomar top 8
            const tiposOrdenados = Object.entries(tipoCargoCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            const tipoLabels = tiposOrdenados.map(t => t[0]);
            const tipoData = tiposOrdenados.map(t => t[1]);
            const tipoAvgRem = tiposOrdenados.map(t =>
                Math.round(tipoCargoSums[t[0]] / tipoCargoCounts[t[0]])
            );

            // Gráfico 19.1 - Distribución por Tipo de Cargo
            const ctx21_1 = document.getElementById('chart21_1');
            if (ctx21_1 && typeof Chart !== 'undefined') {
                new Chart(ctx21_1, {
                    type: 'bar',
                    data: {
                        labels: tipoLabels,
                        datasets: [{
                            label: 'Cantidad',
                            data: tipoData,
                            backgroundColor: '#3b82f6',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Gráfico 19.2 - Remuneración Promedio por Tipo de Cargo
            const ctx21_2 = document.getElementById('chart21_2');
            if (ctx21_2 && typeof Chart !== 'undefined') {
                new Chart(ctx21_2, {
                    type: 'bar',
                    data: {
                        labels: tipoLabels,
                        datasets: [{
                            label: 'Rem. Promedio (CLP)',
                            data: tipoAvgRem,
                            backgroundColor: '#10b981',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: {
                                    callback: v => '$' + (v / 1000000).toFixed(1) + 'M'
                                }
                            }
                        }
                    }
                });
            }

            // === SECCIÓN 20: Análisis de Liquidez ===
            // Nota: Si los datos tienen rem_liquida, usarla. Si no, estimarla como 80% de bruta
            const ORG_PADRE_IDX = 17;

            // Agrupar por organismo padre
            const orgBrutoLiquido = {};

            data.forEach(r => {
                const org = r[ORG_PADRE_IDX] || 'Sin Clasificar';
                const bruto = parseFloat(r[REM_BRUTA_IDX]) || 0;
                // Estimamos líquido como ~78% del bruto (descuentos legales promedio)
                const liquido = bruto * 0.78;

                if (!orgBrutoLiquido[org]) {
                    orgBrutoLiquido[org] = { bruto: 0, liquido: 0, count: 0 };
                }
                orgBrutoLiquido[org].bruto += bruto;
                orgBrutoLiquido[org].liquido += liquido;
                orgBrutoLiquido[org].count++;
            });

            // Top 10 por masa salarial bruta
            const top10Orgs = Object.entries(orgBrutoLiquido)
                .sort((a, b) => b[1].bruto - a[1].bruto)
                .slice(0, 10);

            const orgLabels = top10Orgs.map(o => o[0].substring(0, 25) + (o[0].length > 25 ? '...' : ''));
            const orgBrutoData = top10Orgs.map(o => o[1].bruto / 1000000);
            const orgLiquidoData = top10Orgs.map(o => o[1].liquido / 1000000);
            const orgRatioData = top10Orgs.map(o =>
                Math.round((o[1].liquido / o[1].bruto) * 100)
            );

            // Gráfico 20.1 - Comparativa Bruto vs Líquido
            const ctx22_1 = document.getElementById('chart22_1');
            if (ctx22_1 && typeof Chart !== 'undefined') {
                new Chart(ctx22_1, {
                    type: 'bar',
                    data: {
                        labels: orgLabels,
                        datasets: [
                            {
                                label: 'Bruto (MM CLP)',
                                data: orgBrutoData,
                                backgroundColor: '#6366f1',
                                borderRadius: 5
                            },
                            {
                                label: 'Líquido Est. (MM CLP)',
                                data: orgLiquidoData,
                                backgroundColor: '#10b981',
                                borderRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            // Gráfico 20.2 - Ratio Líquido/Bruto
            const ctx22_2 = document.getElementById('chart22_2');
            if (ctx22_2 && typeof Chart !== 'undefined') {
                new Chart(ctx22_2, {
                    type: 'bar',
                    data: {
                        labels: orgLabels,
                        datasets: [{
                            label: 'Ratio Líquido/Bruto %',
                            data: orgRatioData,
                            backgroundColor: orgRatioData.map(r => r >= 78 ? '#10b981' : '#f59e0b'),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { min: 70, max: 85 }
                        }
                    }
                });
            }


            // === SECCIÓN 21: Nube de Palabras ===
            const CARGO_SALIDA_IDX = 28;
            const cargoCounts = {};

            // Palabras a ignorar
            const stopWords = ['DE', 'LA', 'EL', 'EN', 'Y', 'A', 'PARA', 'CON', 'SIN', 'DEL', 'LAS', 'LOS', 'POR', 'ADMINISTRATIVO', 'AUXILIAR', 'TECNICO', 'PROFESIONAL'];

            data.forEach(r => {
                const cargo = String(r[CARGO_SALIDA_IDX] || '').toUpperCase();
                // Limpiar y tokenizar solo palabras significativas si queremos nube de palabras, 
                // pero mejor nube de CARGOS completos para tener contexto.
                // Si el cargo es muy largo, cortarlo? Mejor usamos cargos completos normalizados.
                if (cargo.length > 2 && cargo !== 'SIN ESPECIFICAR') {
                    cargoCounts[cargo] = (cargoCounts[cargo] || 0) + 1;
                }
            });

            // Top 40 cargos
            const topCargos = Object.entries(cargoCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 40);

            const maxCount = topCargos[0] ? topCargos[0][1] : 1;
            const minCount = topCargos[topCargos.length - 1] ? topCargos[topCargos.length - 1][1] : 0;

            const cloudContainer = document.getElementById('wordCloudContainer');
            if (cloudContainer) {
                let cloudHtml = '';
                const colors = ['#3b82f6', '#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];

                topCargos.forEach(([text, count]) => {
                    // Escalar tamaño entre 0.8rem y 2.5rem
                    const size = 0.8 + ((count - minCount) / (maxCount - minCount)) * 1.7;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const opacity = 0.7 + Math.random() * 0.3;

                    cloudHtml += `<span style="font-size: ${size}rem; color: ${color}; opacity: ${opacity}; font-weight: 700; padding: 0.25rem 0.5rem; transition: all 0.2s; cursor: default;" class="hover:scale-110 hover:opacity-100" title="${count} funcionarios">${text}</span>`;
                });
                cloudContainer.innerHTML = cloudHtml;
            }

            // === SECCIÓN 22: Ranking de Aumentos ===
            const REM_ENTRADA_IDX = 4;
            const NAME_IDX = 9;
            const ORG_IDX = 1;

            const aumentos = [];
            data.forEach(r => {
                const rEntrada = parseFloat(r[REM_ENTRADA_IDX]) || 0;
                const rSalida = parseFloat(r[REM_BRUTA_IDX]) || 0; // Usamos índice definido antes

                if (rEntrada > 500000 && rSalida > rEntrada) { // Filtrar errores de data y aumentos reales
                    const diff = rSalida - rEntrada;
                    const pct = (diff / rEntrada) * 100;
                    if (pct < 1000) { // Filtrar errores absurdos > 1000%
                        aumentos.push({
                            nombre: r[NAME_IDX],
                            org: r[ORG_IDX],
                            entrada: rEntrada,
                            salida: rSalida,
                            diff: diff,
                            pct: pct
                        });
                    }
                }
            });

            // Top 10 Aumentos Absolutos
            const topAumentos = aumentos.sort((a, b) => b.diff - a.diff).slice(0, 10);

            const rankingTable = document.getElementById('rankingAumentosBody');
            if (rankingTable) {
                let rankHtml = '';
                const fmt = (n) => '$ ' + n.toLocaleString('es-CL');

                topAumentos.forEach(a => {
                    rankHtml += `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <td class="px-4 py-3 font-medium text-slate-900 truncate max-w-[200px]" title="${a.nombre}">${a.nombre}</td>
                            <td class="px-4 py-3 text-slate-500 truncate max-w-[200px]" title="${a.org}">${a.org}</td>
                            <td class="px-4 py-3 text-right text-slate-600">${fmt(a.entrada)}</td>
                            <td class="px-4 py-3 text-right text-slate-900 font-bold">${fmt(a.salida)}</td>
                            <td class="px-4 py-3 text-right text-emerald-600 font-semibold">+${fmt(a.diff)}</td>
                            <td class="px-4 py-3 text-right text-emerald-600 font-bold bg-emerald-50 rounded-lg">${Math.round(a.pct)}%</td>
                        </tr>
                    `;
                });
                rankingTable.innerHTML = rankHtml || '<tr><td colspan="6" class="text-center py-4">No hay datos suficientes</td></tr>';
            }

            // === SECCIÓN 23: Tree Map de Gasto (CSS Puro) ===
            // Agrupar masa salarial por Org Padre (reusamos orgBrutoLiquido)
            // Ya tenemos orgBrutoLiquido calculado en sección 20

            // Convertir a array y ordenar
            const treeData = Object.entries(orgBrutoLiquido)
                .map(([name, val]) => ({ name, value: val.bruto }))
                .sort((a, b) => b.value - a.value);

            const totalMasa = treeData.reduce((acc, curr) => acc + curr.value, 0);

            const treeContainer = document.getElementById('treeMapContainer');
            if (treeContainer && totalMasa > 0) {
                let treeHtml = '';
                // Algoritmo simple: cajas proporcionales en grid flow
                // Tomamos top 15 para que se vea bien, el resto a "Otros"
                const topTree = treeData.slice(0, 15);
                const otherVal = treeData.slice(15).reduce((acc, curr) => acc + curr.value, 0);
                if (otherVal > 0) topTree.push({ name: 'OTROS ORGANISMOS', value: otherVal, isOther: true });

                // Colores vibrantes para el treemap
                const treeColors = ['#4f46e5', '#3b82f6', '#06b6d4', '#10b981', '#84cc16', '#f59e0b', '#ef4444', '#ec4899', '#8b5cf6', '#6366f1'];

                topTree.forEach((item, idx) => {
                    const pct = (item.value / totalMasa) * 100;
                    // Para simplificar layout, usamos width % y height fijo o flex grow
                    // Flex wrap con bases pseudo-proporcionales funciona "ok" para visualización simple
                    // Mejor tecnica visual simple:
                    const color = item.isOther ? '#94a3b8' : treeColors[idx % treeColors.length];
                    const txtColor = pct > 2 ? 'white' : 'transparent'; // Ocultar texto si muy chico

                    // Estrategia: Flex con grow proporcional a area? No funciona exacto en 2D.
                    // Usaremos aproximación simple: un solo bloque ancho? No, treemap es 2D.
                    // Simulación: Cajas con width % relativo a viewport, pero haciendo wrap. 
                    // No es un treemap perfecto matemáticamente, pero da la idea de volumen.
                    // Mejor: Grid CSS con áreas generadas? Muy complejo dinámico.
                    // Hack Visual: Usar un div contenedor enorme (flex-row wrap) y asignar anchos % relativos.
                    // Si el contenedor es 1000px ancho, y items suman 1000px, es una barra.
                    // Para que sea 2D, asignamos width y height variables?
                    // Vamos a usar bloques rectangulares simples que llenen el espacio.

                    // Simple Bar Map (Stacks) mejor visualmente que Treemap falso.
                    // Pero el usuario pidió Treemap. Intentaré simular "Squarified" simple con areas float?
                    // Usaremos simple % width con float left y height 50% o 100% alternado para variedad?
                    // Probemos Flex grow con min-width.

                    // Solución Robust: Cajas con Area = % del total.
                    // width = sqrt(pct) * k, height = sqrt(pct) * k? 
                    // No. Usaremos estilo "Mosaic Layout".

                    const area = pct; // Porcentaje del area total
                    // Mapear area visual.
                    // Si > 20%, width 50%, height 40%?
                    // Simplemente haremos bloques flex que suman 100% width en varias filas.
                    // Asumiendo altura fija container 400px.
                    // Area total = 400 * 100% = 40000 unidades.
                    // Item area = pct * 400.

                    // Alternativa: Mostrar como Barras Anchas (Horizontal Stacked Bar gigante multi-linea).
                    // Se ve como un Treemap lineal (Partition Chart). Es preciso y facil.

                    treeHtml += `
                        <div style="width: ${pct}%; height: 100%; background: ${color}; border: 1px solid white; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; position: relative;" class="group hover:opacity-90 transition-opacity" title="${item.name}: $${(item.value / 1000000).toFixed(0)}M (${pct.toFixed(1)}%)">
                            ${pct > 4 ? `
                                <div class="text-white font-bold text-center leading-tight px-1 text-xs md:text-sm sticky truncate w-full">${item.name}</div>
                                <div class="text-white/80 text-xs">${pct.toFixed(1)}%</div>
                            ` : ''}
                        </div>
                    `;
                });

                // Como hacer que ocupen varias lineas y conserven area? 
                // Un div flex row con wrap? Si width suma 100%, es una linea. 
                // Para Treemap simulado:
                // Haremos un layout de 2 columnas. Col 1: items grandes. Col 2: items chicos.
                // Mas simple: Partition Chart (Barra única 100% width x 100% height? No, varias columnas).
                // Ok, para esta implementación rápida SIN librerías, usaré un "Flex Mosaic":
                // Todos height 50% (2 filas).
                // Ordenar para llenar fila 1 y luego fila 2.

                // Re-calculo para visualización "Treemap-ish" (2 rows layout)
                let row1Html = '';
                let row2Html = '';
                let row1Limit = 60; // 60% del gasto arriba
                let currentTotal = 0;

                topTree.forEach((item, idx) => {
                    const pct = (item.value / totalMasa) * 100;
                    const color = item.isOther ? '#94a3b8' : treeColors[idx % treeColors.length];
                    const content = pct > 2.5 ? `<div class="font-bold truncate px-1">${item.name}</div><div class="text-xs opacity-80">${pct.toFixed(1)}%</div>` : '';

                    // Normalizar anchos para llenar 100% de su fila
                    // Esto requiere doble pase.
                    // Simplificamos: DIVISIÓN EXACTA NO. FLEX-GROW SI.

                    const block = `
                        <div style="background-color: ${color}; flex-grow: ${Math.round(item.value)};" class="h-full border border-white flex flex-col items-center justify-center text-white text-center p-1 min-w-[40px] overflow-hidden group relative" title="${item.name}: $${(item.value / 1000000).toFixed(0)}M">
                            ${content}
                        </div>
                    `;

                    // Llenar primera mitad visualmente
                    if (currentTotal < 50) {
                        row1Html += block;
                    } else {
                        row2Html += block;
                    }
                    currentTotal += pct;
                });

                treeContainer.innerHTML = `
                    <div class="w-full h-1/2 flex">${row1Html}</div>
                    <div class="w-full h-1/2 flex">${row2Html}</div>
                `;
            }

        }, 3000);
        // === BOTÓN SCROLL TOP ===
        const btnScrollTop = document.getElementById('btnScrollTop');

        if (btnScrollTop) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    btnScrollTop.classList.remove('translate-y-20', 'opacity-0');
                } else {
                    btnScrollTop.classList.add('translate-y-20', 'opacity-0');
                }
            });

            btnScrollTop.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
    </script>
</body>

</html>